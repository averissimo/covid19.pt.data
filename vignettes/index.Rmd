---
title: "COVID-19 Portugal data"
output: 
  html_document:
    toc: true
    dev: svg
---

```{r, eval=FALSE, include=FALSE}
rmarkdown::render('index.Rmd')
```

```{r, eval=FALSE, include=FALSE}
rmarkdown::clean_site()
rmarkdown::render_site(quiet = TRUE)
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::load_all()
library(pdftools)
library(rvest)
library(dplyr)
library(tibble)
library(DT)
library(anytime)
library(glue)
library(reshape2)
library(zoo)
library(xml2)
library(usethis)
library(ggplot2)
library(ggrepel)
library(plotly)
library(viridis)

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')
```

The report was generated on `r format.Date(Sys.time(), '%A, %B %d, %Y at %Hh%M %Z (%z)')`

# Preface

This is a personal analysis of the cases of covid-19.

I'm not an Epidemiologist! I'm a researcher with a background in computer science and bioinformatics.

The source code is at [averissimo/r-analysis-covid19](https://github.com/averissimo/r-analysis-covid19), [averissimo/covid19.de.data](https://github.com/averissimo/covid19.de.data) and [averissimo/covid19.pt.data](https://github.com/averissimo/covid19.pt.data)

## Other covid-19 confirmed/deaths analysis

* [World](https://averissimo.github.io/covid19-analysis/)
* [Germany](https://averissimo.github.io/covid19-analysis/germany.html) *(by state)*
* [Italy](https://averissimo.github.io/covid19-analysis/italy.html) *(by region)*
* [Spain](https://averissimo.github.io/covid19-analysis/spain.html) *(by region)*

## Age group analysis

* [Portugal](https://averissimo.github.io/covid19.pt.data/)
* [Germany](https://averissimo.github.io/covid19.de.data/) *(by state and district)*

# Data  {.tabset .tabset-fade .tabset-pills}

Data was retrieved from oficial sources.

* World: [EU CDC](https://data.europa.eu/euodp/en/data/dataset/covid-19-coronavirus-data) *(if not available it uses [Johns Hopkins](https://github.com/CSSEGISandData/COVID-19/))*
* Italy: [Protezione Civil](https://github.com/pcm-dpc/COVID-19) *(IT PC)*
* Portugal [Direcção Geral da Saúde](https://covid19.min-saude.pt/relatorio-de-situacao/) *(PT DGS)*
* Germany [Robert Koch's Institute](https://www.arcgis.com/home/item.html?id=dd4580c810204019a7b8eb3e0b329dd6&view=list#overview) *(DE RKI)*
* Spain: [Ministerio de Sanidad](https://covid19.isciii.es/) *(ES ISCIII)*
* USA: [COVID Tracking Project](https://covidtracking.com/) *(USA covidtracking.com)*
    * Not a direct official source, but it scrappes from official sources given by individual state's health departments.

It's not realtime data and data presented may have 1 or more days of difference from real-time data. Check the caption on the figures to check when was the last data point.

```{r, message=FALSE, include=FALSE}
dat <- download.updated.pt()

dgs.pt.new     <- dat$dgs.pt 
covid19.pt.new <- dat$cdc.eu
```

```{r, include=FALSE}
dgs.pt <- tibble()
tryCatch(dgs.pt <- covid19.pt.data::dgs.pt, error = function(err) { })

# DGS PT
if (nrow(dgs.pt.new) != nrow(dgs.pt)) {
  dgs.pt <- dgs.pt.new 
  usethis::use_data(dgs.pt, overwrite = TRUE)
  readr::write_csv(dgs.pt, path = '../data/dgs_pt.csv')
}

# EU CDC
covid19.pt <- tibble()
tryCatch(covid19.pt <- covid19.pt.data::covid19.pt, error = function(err) { })

if (nrow(covid19.pt.new) != nrow(covid19.pt)) {
  covid19.pt <- covid19.pt.new
  usethis::use_data(covid19.pt, overwrite = TRUE)
  readr::write_csv(covid19.pt, path = '../data/covid19_pt.csv')
}

```

```{r, include=FALSE}
age.data <- dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type') %>% 
  group_by(country, type) %>% 
  filter(grepl('(confirmed_|death_)', type)) %>% 
  arrange(date) %>% 
  ungroup() %>% 
  mutate(gender = if_else(grepl('.*_m_*', type), 'men', 'women'),
         age_type = if_else(grepl('confirmed_', type), 'confirmed', 'death'),
         type = gsub('.*_(m|w)_', '', type),
         value = if_else(gender == 'men', value * -1, value %>% as.double))
```

## Cumulative data for Portugal

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=7}
my.plot.data <- dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type', measure.vars = c('tests', 'deaths', 'confirmed', 'hospitalized', 'in.icu', 'recovered')) %>% 
  filter(!is.na(value)) %>% 
  mutate(type = 
           gsub('confirmed', 'Confirmed cases', type) %>% 
           gsub('deaths', 'Deaths', .) %>% 
           gsub('recovered', 'Recovered', .) %>% 
           gsub('hospitalized', 'Hospitalized', .) %>% 
           gsub('in.icu', 'In ICU', .) %>% 
           gsub('tests', 'Tests', .)) %>% 
  mutate(text = format(value, big.mark = ',', trim = TRUE)) %>%
  ungroup() %>% 
  select(Date = date, Type = type, value = value, text = text) %>% 
  arrange(Date) 

d <- my.plot.data  %>%  
  highlight_key(~Type)

pal <- viridis(my.plot.data$Type %>% length, end = .8, option = 'A')

d %>% plot_ly() %>% 
  add_trace(x = ~Date, 
            y = ~value, 
            color = ~Type, 
            type = 'scatter',
            mode = 'lines+markers', 
            colors = pal, 
            name = ~Type,
            customdata = ~text,
            hovertemplate = paste0('<b>%{customdata}</b>', '<br><i>%{text}</i>', '<br><i>%{x}</i>'),
            text = ~Type
            ) %>% 
  layout(legend = list(x = 0.1, y = 1), dragmode = FALSE,
         title = 'Individuals that were Infected, Recovered and Died',
         xaxis = list(title = 'Date'),
         yaxis = list(title = 'Number of individuals', type = 'log')) %>% 
  highlight(on = 'plotly_click', off = 'plotly_doubleclick')
```

## Data per day

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=7}
my.plot.data <- dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type', measure.vars = c('tests', 'deaths', 'confirmed', 'hospitalized', 'in.icu', 'recovered')) %>% 
  filter(!is.na(value)) %>% 
  mutate(type = 
           gsub('confirmed', 'Confirmed cases', type) %>% 
           gsub('deaths', 'Deaths', .) %>% 
           gsub('recovered', 'Recovered', .) %>% 
           gsub('hospitalized', 'Hospitalized', .) %>% 
           gsub('in.icu', 'In ICU', .) %>% 
           gsub('tests', 'Tests', .)) %>% 
  group_by(country, type) %>% 
  arrange(desc(date)) %>% 
  mutate(value = zoo::rollapply(value, 2, function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE)) %>%
  mutate(text = format(value, big.mark = ',', trim = TRUE)) %>%
  ungroup() %>% 
  #filter(value != 0) %>% 
  select(Date = date, Type = type, value = value, text = text) %>% 
  arrange(Date) 

d <- my.plot.data  %>%  
  highlight_key(~Type)

pal <- viridis(my.plot.data$Type %>% length, end = .8, option = 'A')

d %>% plot_ly() %>% 
  add_trace(x = ~Date, 
            y = ~value, 
            color = ~Type, 
            type = 'scatter',
            mode = 'lines+markers', 
            colors = pal, 
            name = ~Type,
            customdata = ~text,
            hovertemplate = paste0('<b>%{customdata}</b>', '<br><i>%{text}</i>', '<br><i>%{x}</i>'),
            text = ~Type
            ) %>% 
  layout(legend = list(x = 0.1, y = 1), dragmode = FALSE,
         title = 'Individuals that were Infected, Recovered and Died',
         xaxis = list(title = 'Date'),
         yaxis = list(title = 'Number of individuals')) %>% 
  highlight(on = 'plotly_click', off = 'plotly_doubleclick')
```

# Cases / Deaths by age groups {.tabset .tabset-fade .tabset-pills}

```{r, results='asis', echo=FALSE,fig.width=4, warning=FALSE}
ixs <- unique(age.data %>% arrange(desc(date)) %>% pull(date))

confirmed.max <- age.data %>% filter(age_type == 'confirmed') %>%  pull(value) %>% max
death.max <- age.data %>% filter(age_type == 'death') %>%  pull(value) %>% max
for (age.ix in seq_along(ixs)) {
  age.ix.f <- ixs[age.ix]
  cat('\n')
  cat('\n')
  cat('## {age.ix.f}' %>% glue)
  cat('\n')
  cat('\n')
  
  confi.dat <- age.data %>% 
    filter(date == age.ix.f & age_type == 'confirmed' & value != 0) %>% 
    mutate(label = if_else(value != 0, format(abs(value), big.mark = ','), NA_character_))

  death.dat <- age.data %>% 
    filter(date == age.ix.f & age_type == 'death' & value != 0) %>% 
    mutate(label = if_else(value != 0, format(abs(value), big.mark = ','), NA_character_))
  
  print(confi.dat %>% 
    ggplot(aes(x = value, y = type, fill = gender)) +
    geom_bar(stat = 'identity') + 
    ggrepel::geom_label_repel(aes(label = label, fill = gender), color = 'white', direction = 'x', seed = 1985, size = 3.5,
                              nudge_x = ifelse(confi.dat$gender == 'men', -1, 1),
                              show.legend = FALSE) +
    expand_limits(x =c(-1 * confirmed.max, confirmed.max)) +
    expand_limits(x =c(-1 * confirmed.max, confirmed.max)) +
    scale_x_continuous('', labels = function(ix) { return(abs(ix)) }) +
    scale_y_discrete(limits = age.data$type %>% unique %>% sort) + 
    scale_fill_viridis_d('',end = .8) + 
    labs(title = "Confirmed cases up to {age.ix.f}" %>% glue,
         y = 'Age group',
         x = 'Confirmed Cases') +
    theme_minimal() + 
    theme(legend.position = 'bottom'))
  print(death.dat %>% 
    ggplot(aes(x = value, y = type, fill = gender)) +
    geom_bar(stat = 'identity') + 
    ggrepel::geom_label_repel(aes(label = label, fill = gender), color = 'white', direction = 'x', seed = 1985, size = 3.5,
                              nudge_x = ifelse(death.dat$gender == 'men', -1, 1),
                              show.legend = FALSE) +
    expand_limits(x =c(-1 * death.max, death.max)) +
    scale_x_continuous('', labels = function(ix) { return(abs(ix)) }) +
    scale_y_discrete(limits = age.data$type %>% unique %>% sort) + 
    scale_fill_viridis_d('',end = .8) + 
    labs(title = "Deaths up to {age.ix.f}" %>% glue,
         y = 'Age group',
         x = 'Deaths') +
    theme_minimal() + 
    theme(legend.position = 'bottom'))
  cat('\n')
  cat('\n')
}
```

# New Cases / Deaths by age groups {.tabset .tabset-fade .tabset-pills}

```{r, results='asis', echo=FALSE,fig.width=4, warning=FALSE}
age.data.new <- age.data %>% 
  mutate(value = abs(value)) %>% 
  group_by(country, type, gender, age_type) %>% 
  arrange(desc(date)) %>% 
  mutate(value = zoo::rollapply(value, 2, function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE)) %>%
  filter(value > 0) %>% 
  mutate(value = if_else(gender == 'men', value * -1, value %>% as.double))

ixs <- unique(age.data.new %>% arrange(desc(date)) %>% pull(date))

confirmed.max <- age.data.new %>% filter(age_type == 'confirmed') %>%  pull(value) %>% max
death.max <- age.data.new %>% filter(age_type == 'death') %>%  pull(value) %>% max
for (age.ix in seq_along(ixs)) {
  age.ix.f <- ixs[age.ix]
  
  confi.dat <- age.data.new %>% 
    filter(date == age.ix.f & age_type == 'confirmed' & value != 0) %>% 
    mutate(label = if_else(value != 0, format(abs(value), big.mark = ','), NA_character_))

  death.dat <- age.data.new %>% 
    filter(date == age.ix.f & age_type == 'death' & value != 0) %>% 
    mutate(label = if_else(value != 0, format(abs(value), big.mark = ','), NA_character_))

  cat('\n')
  cat('\n')
  cat('## {age.ix.f}' %>% glue)
  cat('\n')
  cat('\n')
  print(confi.dat %>% 
    ggplot(aes(x = value, y = type, fill = gender)) +
    geom_bar(stat = 'identity') + 
    ggrepel::geom_label_repel(aes(label = label, fill = gender), color = 'white', direction = 'x', seed = 1985, size = 3.5,
                              nudge_x = ifelse(confi.dat$gender == 'men', -1, 1),
                              show.legend = FALSE) +
    expand_limits(x =c(-1 * confirmed.max, confirmed.max)) +
    scale_x_continuous('', labels = function(ix) { return(abs(ix)) }) +
    scale_y_discrete(limits = age.data$type %>% unique %>% sort) + 
    scale_fill_viridis_d('',end = .8) + 
    labs(title = "Confirmed cases from {age.ix.f}" %>% glue,
         y = 'Age group',
         x = 'Confirmed Cases') +
    theme_minimal() + 
    theme(legend.position = 'bottom'))
  print(death.dat %>%
    ggplot(aes(x = value, y = type, fill = gender)) +
    geom_bar(stat = 'identity') + 
    ggrepel::geom_label_repel(aes(label = label, fill = gender), color = 'white', direction = 'x', seed = 1985, size = 3.5,
                              nudge_x = ifelse(death.dat$gender == 'men', -1, 1),
                              show.legend = FALSE) +
    expand_limits(x =c(-1 * death.max, death.max)) +
    scale_x_continuous('', labels = function(ix) { return(abs(ix)) }) +
    scale_fill_viridis_d('',end = .8) + 
    scale_y_discrete(limits = age.data$type %>% unique %>% sort) + 
    labs(title = "Deaths from {age.ix.f}" %>% glue,
         y = 'Age group',
         x = 'Deaths') +
    theme_minimal() + 
    theme(legend.position = 'bottom'))
  cat('\n')
  cat('\n')
}
```

# Data {.tabset .tabset-fade .tabset-pills}

## Data from DGS

Only showing last 10 days

```{r, echo=FALSE}
dgs.pt %>% arrange(desc(date)) %>% top_n(10, date) %>% knitr::kable()
```

## Data from EU CDC updated

Only showing last 10 days

```{r, message=FALSE, echo=FALSE}
covid19.pt.new %>% head(10) %>% knitr::kable()
```




