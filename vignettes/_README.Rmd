---
title: "COVID-19 Portugal data"
output: 
  github_document:
    dev: svg
---

```{r, eval=FALSE, include=FALSE}
rmarkdown::render('_README.Rmd', output_file = 'README.md')
```

```{r, eval=FALSE, include=FALSE}
rmarkdown::clean_site()
rmarkdown::render_site(quiet = TRUE)
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::load_all()
library(pdftools)
library(rvest)
library(dplyr)
library(tibble)
library(DT)
library(anytime)
library(glue)
library(reshape2)
library(zoo)
library(xml2)
library(ggplot2)
library(ggrepel)
library(plotly)

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')
```

```{r, message=FALSE, include=FALSE}
dat <- download.updated.pt()

dgs.pt.new     <- dat$dgs.pt 
covid19.pt.new <- dat$cdc.eu

dgs.pt <- tibble()
tryCatch(dgs.pt <- covid19.pt.data::dgs.pt, error = function(err) { })

# DGS PT
if (nrow(dgs.pt.new) != nrow(dgs.pt)) {
  dgs.pt <- dgs.pt.new 
  usethis::use_data(dgs.pt, overwrite = TRUE)
  readr::write_csv(dgs.pt, path = '../data/dgs_pt.csv')
}

# EU CDC
covid19.pt <- tibble()
tryCatch(covid19.pt <- covid19.pt.data::covid19.pt, error = function(err) { })

if (nrow(covid19.pt.new) != nrow(covid19.pt)) {
  covid19.pt <- covid19.pt.new
  usethis::use_data(covid19.pt, overwrite = TRUE)
  readr::write_csv(covid19.pt, path = '../data/covid19_pt.csv')
}
```

> R package with latest data scrapped from official sources *(last data from `r format(max(dgs.pt.new$date), "%A, %B %d, %Y")`)*

It downloads the [daily report](https://covid19.min-saude.pt/relatorio-de-situacao/) from DGS and stores this in data-friendly format under `/data` directory.

If you are here just for the data, this is what you want: 

* [dgs_pt.csv](raw/master/data/dgs_pt.csv) *(raw data from Portugal's DGS)*
* [covid19_pt.csv](raw/master/data/covid19_pt.csv) *(updated EU CDC dataset only featuring Portugal)*

A more detailed analysis of this data is [available here](https://averissimo.github.io/covid19-analysis/portugal.html)

# Check for new reports

```{r, eval=FALSE}
download.updated.pt()
```

```{r, echo=FALSE}
dgs.pt <- dgs.pt.new 
```

```{r, echo=FALSE}
age.data <- get.age.data(dgs.pt)
```

## Data for Portugal

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=7}
dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type', measure.vars = c('deaths', 'confirmed', 'hospitalized', 'in.icu', 'recovered')) %>% 
  mutate(type = 
           gsub('confirmed', 'Confirmed cases', type) %>% 
           gsub('deaths', 'Deaths', .) %>% 
           gsub('hospitalized', 'Hospitalized', .) %>% 
           gsub('recovered', 'Recovered', .) %>% 
           gsub('tests', 'Suspected individuals', .) %>% 
           gsub('in.icu', 'In ICU', .)) %>% 
  group_by(country, type) %>% 
  arrange(date) %>% 
  mutate(label = if_else(date == last(date), 
                         paste0(type, ': ', 
                                format(value, digits = 2, big.mark =',', trim = FALSE)), 
                         NA_character_)) %>% 
  ggplot(aes(x = date, y = value, color = type, label = label, fill = type)) +
    geom_line(size = 1, alpha = .6) + 
    geom_point(size = 2.5) +
    ggrepel::geom_label_repel(color = 'white', 
                              segment.color = 'black', 
                              na.rm = TRUE, 
                              min.segment.length = 0, 
                              #nudge_x = -2,
                              #nudge_y = -.5,
                              segment.alpha = .8,
                              size = 3.5,
                              max.iter = 4000,
                              seed = 1985) +
    scale_x_date(date_labels = '%B %d (%a)', date_breaks = "5 day", date_minor_breaks = "1 day") +
    labs(x = 'Date', 
         y = 'Number of individuals',
         title = 'Individuals that were Infected, Recovered and Died',
         subtitle = 'Showing in Logarithmic scale (base 10)',
         caption = "{format(max(dgs.pt.new$date), '%A, %B %d, %Y')}\n Label points to the maximum point in time" %>% glue::glue()) +
    scale_y_continuous(trans = 'log10', labels = function(ix) { format(ix, big.mark = ',', scientific = FALSE) }) +
    scale_color_viridis_d(end = .7) +
    scale_fill_viridis_d(end = .7) +
    theme_minimal() +
    theme(legend.position = 'none', axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=7}
plot.data <- dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type', measure.vars = c('deaths', 'confirmed', 'hospitalized', 'in.icu', 'recovered')) %>% 
  mutate(type = 
           gsub('confirmed', 'Confirmed cases', type) %>% 
           gsub('deaths', 'Deaths', .) %>% 
           gsub('hospitalized', 'Hospitalized', .) %>% 
           gsub('recovered', 'Recovered', .) %>% 
           gsub('tests', 'Suspected individuals', .) %>% 
           gsub('in.icu', 'In ICU', .)) %>% 
  group_by(country, type) %>% 
  arrange(desc(date)) %>% 
  mutate(value = zoo::rollapply(value, 
                                2, 
                                function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE)) %>%
  group_by(country, type) %>% 
  arrange(date) %>% 
  filter(date > min(date)) %>%  ## values will not be for that day
  build.labels('value', 'type') 

roundUp <- function(x) 10^ceiling(log10(x))
my.breaks <- c(-100, -40, -20, -10, -5, -2, 0, 2, 5, 10, 30, 100, 300, 1000, 3000, 10000, 20000)

my.breaks <- c(my.breaks, max(plot.data$value, na.rm = TRUE) %>% roundUp(), -1 * (abs(min(plot.data$value, na.rm = TRUE)) %>% roundUp())) %>% 
  unique %>% 
  sort

plot.data %>% 
  ggplot(aes(x = date, y = value, color = type, label = label, fill = type)) +
    geom_hline(aes(yintercept = 0), size = .7, alpha = .3, linetype = 3) +
    geom_line(size = 1, alpha = .6) + 
    geom_point(size = 2.5) +
    ggrepel::geom_label_repel(color = 'white', 
                              segment.color = 'black', 
                              na.rm = TRUE, 
                              min.segment.length = 0, 
                              #nudge_x = -2,
                              #nudge_y = -.5,
                              segment.alpha = .8,
                              size = 3.5,
                              seed = 1985) +
    labs(x = 'Date', 
         y = 'Number of individuals',
         title = 'Individuals that were Infected, Recovered and Died',
         subtitle = 'Showing in a (pseudo) logarithmic scale',
         caption = "{format(max(dgs.pt.new$date), '%A, %B %d, %Y')}\n Label points to the maximum point in time" %>% glue::glue()) +
    scale_x_date(date_labels = '%B %d (%a)', date_breaks = "3 day", date_minor_breaks = "1 day") +
    scale_color_viridis_d(end = .7) +
    scale_fill_viridis_d(end = .7) +
    scale_y_continuous(trans = scales::pseudo_log_trans(sigma = 1, base = 10), 
                       labels = function(ix) { format(ix, big.mark = ',', scientific = FALSE) },
                       breaks =  my.breaks) +
    theme_minimal() +
    theme(legend.position = 'none', axis.text.x = element_text(angle = 45, hjust = 1, size = 5))
```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=7}
plot.data <- dgs.pt %>% 
  reshape2::melt(id.vars = c('country', 'date'), variable.name = 'type', measure.vars = c('deaths', 'confirmed', 'hospitalized', 'in.icu', 'recovered')) %>% 
  mutate(type = 
           gsub('confirmed', 'Confirmed cases', type) %>% 
           gsub('deaths', 'Deaths', .) %>% 
           gsub('hospitalized', 'Hospitalized', .) %>% 
           gsub('recovered', 'Recovered', .) %>% 
           gsub('tests', 'Suspected individuals', .) %>% 
           gsub('in.icu', 'In ICU', .)) %>% 
  group_by(country, type) %>% 
  arrange(desc(date)) %>% 
  mutate(value = zoo::rollapply(value, 
                                2, 
                                function(ix) { if(length(ix) <= 1) { return(ix) } else { ix[1] - sum(ix[-1]) } }, fill = c(0, 0, 0), align = 'left', partial = TRUE)) %>%
  mutate(value = zoo::rollapply(value, 7, mean, align = 'left', fill = c(0,0,0), partial = TRUE)) %>%
  group_by(country, type) %>% 
  arrange(date) %>% 
  filter(date > min(date)) %>%  ## values will not be for that day
  build.labels('value', 'type') 

roundUp <- function(x) 10^ceiling(log10(x))
my.breaks <- c(-100, -40, -20, -10, -5, -2, 0, 2, 5, 10, 30, 100, 300, 1000, 3000, 10000, 20000)

my.breaks <- c(my.breaks, max(plot.data$value, na.rm = TRUE) %>% roundUp(), -1 * (abs(min(plot.data$value, na.rm = TRUE)) %>% roundUp())) %>% 
  unique %>% 
  sort

plot.data %>% 
  ggplot(aes(x = date, y = value, color = type, label = label, fill = type)) +
    geom_hline(aes(yintercept = 0), size = .7, alpha = .3, linetype = 3) +
    geom_line(size = 1, alpha = .6) + 
    geom_point(size = 2.5) +
    ggrepel::geom_label_repel(color = 'white', 
                              segment.color = 'black', 
                              na.rm = TRUE, 
                              min.segment.length = 0, 
                              #nudge_x = -2,
                              #nudge_y = -.5,
                              segment.alpha = .8,
                              size = 3.5,
                              seed = 1985) +
    labs(x = 'Date', 
         y = 'Number of individuals',
         title = '7-day average of Individuals that were Infected, Recovered and Died',
         subtitle = 'Showing in a (pseudo) logarithmic scale',
         caption = "{format(max(dgs.pt.new$date), '%A, %B %d, %Y')}\n Label points to the maximum point in time" %>% glue::glue()) +
    scale_x_date(date_labels = '%B %d (%a)', date_breaks = "3 day", date_minor_breaks = "1 day") +
    scale_color_viridis_d(end = .7) +
    scale_fill_viridis_d(end = .7) +
    scale_y_continuous(trans = scales::pseudo_log_trans(sigma = 1, base = 10), 
                       labels = function(ix) { format(ix, big.mark = ',', scientific = FALSE) },
                       breaks =  my.breaks) +
    theme_minimal() +
    theme(legend.position = 'none', axis.text.x = element_text(angle = 45, hjust = 1, size = 5))
```


# New cases / deaths by age groups

(removed as it was removed from official data)

# Data {.tabset .tabset-fade .tabset-pills}

## Data from DGS

Only showing last 10 days

```{r, echo=FALSE}
dgs.pt %>% arrange(desc(date)) %>% top_n(20, date) %>% knitr::kable()
```

## Data from EU CDC updated

Only showing last 10 days.

Don't be alarmed with the first line being in the future, EU CDC date always refer to the situation on the previous day.

```{r, message=FALSE, echo=FALSE}
covid19.pt %>% head(10) %>% knitr::kable()
```




